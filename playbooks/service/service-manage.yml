---
- name: Run Docker Compose in service's root folder. 
  hosts: all
  become: yes
  gather_facts: yes
  vars:
    siteParam: "{{ service }}"

  vars_files:
    - ./configs/dojo.yml
    - ./services/{{ service }}.yml

  tasks:
    - name: Check if the service directory exists
      stat:
        path: "{{ path.base.service }}/{{ dojo.id }}"
      register: service_dir_stat

    - name: Fail if service directory does not exist
      fail:
        msg: "Service directory does not exist"
      when: not service_dir_stat.stat.exists

    - name: Runs "docker compose <command>" in the service's directory
      command: >
        docker compose {{ command }}
      args:
        chdir: "{{ path.base.service }}/{{ dojo.id }}"
      when: command in ['start', 'stop', 'restart', 'down', 'pull', 'pause', 'unpause', 'build']
